#include "AccelGyro.h"
#include "Arduino.h"
#include "math.h"
#include "Wire.h"

AccelGyro::AccelGyro(void) {
	_address = 0x68;
}

AccelGyro::AccelGyro(int address) {
	_address = address;
}

Rotation::Rotation(void) {
	x = 0.0;
	y = 0.0;
	z = 0.0;
}

Correction::Correction(void) {
	x = 0.0;
	y = 0.0;
	z = 0.0;
}

SensorData::SensorData(void) {
	x = 0.0;
	y = 0.0;
	z = 0.0;
}

RawSensorData::RawSensorData(void) {
	x = 0;
	y = 0;
	z = 0;
}

Rotation::Rotation(double x, double y, double z) {
	this->x = x;
	this->y = y;
	this->z = z;
}

Correction::Correction(double x, double y, double z) {
	this->x = x;
	this->y = y;
	this->z = z;
}

SensorData::SensorData(double x, double y, double z) {
	this->x = x;
	this->y = y;
	this->z = z;
}

RawSensorData::RawSensorData(int16_t x, int16_t y, int16_t z) {
	this->x = x;
	this->y = y;
	this->z = z;
}

void Rotation::Correct(Correction correction) {
	x -= correction.x;
	y -= correction.y;
	z -= correction.z;
}

void RawSensorData::Correct(Correction correction) {
	x -= correction.x;
	y -= correction.y;
	z -= correction.z;
}

SensorData RawSensorData::ToSensorData(const float* scaleModifiers, int sensivity) {
	SensorData sensorData;
	sensorData.x = x / scaleModifiers[sensivity];
	sensorData.y = y / scaleModifiers[sensivity];
	sensorData.z = z / scaleModifiers[sensivity];
	return sensorData;
}

void SensorData::Add(SensorData sensorData) {
	x += sensorData.x;
	y += sensorData.y;
	z += sensorData.z;
}

void Rotation::Add(Rotation rotation) {
	x += rotation.x;
	y += rotation.y;
	z += rotation.z;
}

void RawSensorData::Add(RawSensorData rawSensorData) {
	x += rawSensorData.x;
	y += rawSensorData.y;
	z += rawSensorData.z;
}

void AccelGyro::Initialize() {
	Wire.begin();
	_accelCorrection = Correction(-0.13, -0.78, 0.0);
	_gyroCorrection = Correction(0.0, 0.0, 0.0);
	_compFilterAlpha = 0.04;
	_prevMeasurementTime = micros();
	I2cWriteData(POWER_REG, 0x00);
	delay(100);
	SetAccelSensitivity(ACCEL_4G);
	SetGyroSensitivity(GYRO_500_DEG);
	_rotation = GetRotationAccel();
}

void AccelGyro::I2cWriteData(int address, byte data) {
	Wire.beginTransmission(_address);
	Wire.write(address);
	Wire.write(data);
	Wire.endTransmission(true);
}

void AccelGyro::I2cReadData(int address, byte* output, int numberOfBytes) {
	Wire.beginTransmission(_address);
	Wire.write(address);
	Wire.endTransmission(false);
	Wire.requestFrom(_address, numberOfBytes, true);

	for (int i = 0; i < numberOfBytes; i++) {
		output[i] = Wire.read();
	}
}

byte AccelGyro::I2cReadOneByte(int address) {
	Wire.beginTransmission(_address);
	Wire.write(address);
	Wire.endTransmission(false);
	Wire.requestFrom(_address, 1, true);
	return Wire.read();
}

bool AccelGyro::IsConnected() {
	byte checkConnValue = I2cReadOneByte(CHECK_CONN_REG);
	return checkConnValue == _address;
}

RawSensorData AccelGyro::GetRawData(int dataRegister) {
	byte rawData[6];
	RawSensorData rawSensorData;
	I2cReadData(dataRegister, rawData, 6);
	rawSensorData.x = (rawData[0] << 8 | rawData[1]);
	rawSensorData.y = (rawData[2] << 8 | rawData[3]);
	rawSensorData.z = (rawData[4] << 8 | rawData[5]);
	return rawSensorData;
}

SensorData AccelGyro::GetData(int dataRegister) {
	SensorData sensorData;
	const float* scaleModifiers = dataRegister == ACCEL_DATA_REG ? _accelScaleModifiers : _gyroScaleModifiers;
	int sensitivityLevel = dataRegister == ACCEL_DATA_REG ? _accelSensitivityLevel : _gyroSensitivityLevel;
	RawSensorData rawSensorData = GetRawData(dataRegister);
	if (dataRegister == GYRO_DATA_REG) rawSensorData.Correct(_gyroCorrection);
	sensorData = rawSensorData.ToSensorData(scaleModifiers, sensitivityLevel);
	return sensorData;
}

Rotation AccelGyro::GetRotationAccel() {
	Rotation accelRotation;
	SensorData accelData = GetData(ACCEL_DATA_REG);
	accelRotation.x = atan2(accelData.y, sqrt(pow(accelData.x, 2) + pow(accelData.z, 2))) * RAD_TO_DEG;
	accelRotation.y = atan2(-accelData.x, sqrt(pow(accelData.y, 2) + pow(accelData.z, 2))) * RAD_TO_DEG;
	accelRotation.z = 0.0;
	accelRotation.Correct(_accelCorrection);
	return accelRotation;
}

Rotation AccelGyro::GetRotationGyro() {
	float microsecondsInSecond = 1000000.0;
	Rotation gyroRotation;
	unsigned long currentTime;
	double elapsedTime;
	SensorData gyroData = GetData(GYRO_DATA_REG);
	currentTime = micros();
	elapsedTime = (currentTime - _prevMeasurementTime) / microsecondsInSecond;
	gyroRotation.x = gyroData.x * elapsedTime;
	gyroRotation.y = gyroData.y * elapsedTime;
	gyroRotation.z = gyroData.z * elapsedTime;
	_prevMeasurementTime = currentTime;
	return gyroRotation;
}

Rotation AccelGyro::GetRotation() {
	Rotation rotationAccel, rotationGyro;
	rotationAccel = GetRotationAccel();
	rotationGyro = GetRotationGyro();
	_rotation.x = (1 - _compFilterAlpha) * (_rotation.x + rotationGyro.x) + _compFilterAlpha * rotationAccel.x;
	_rotation.y = (1 - _compFilterAlpha) * (_rotation.y + rotationGyro.y) + _compFilterAlpha * rotationAccel.y;
	_rotation.z += rotationGyro.z;
	return _rotation;
}

void AccelGyro::SetGyroSensitivity(int sensitivityLevel) {
	_gyroSensitivityLevel = sensitivityLevel;
	I2cWriteData(GYRO_CONF_REG, _gyroSensitivityLevel << 3);
	delay(50);
}

void AccelGyro::SetAccelSensitivity(int sensitivityLevel) {
	_accelSensitivityLevel = sensitivityLevel;
	I2cWriteData(ACCEL_CONF_REG, _accelSensitivityLevel << 3);
	delay(50);
}

void AccelGyro::SetAccelCorrection(Correction correction) {
	_accelCorrection.x = correction.x;
	_accelCorrection.y = correction.y;
	_accelCorrection.z = correction.z;
}

void AccelGyro::SetGyroCorrection(Correction correction) {
	_gyroCorrection.x = correction.x;
	_gyroCorrection.y = correction.y;
	_gyroCorrection.z = correction.z;
}

void AccelGyro::SetAccelCorrection(double x, double y, double z) {
	_accelCorrection.x = x;
	_accelCorrection.y = y;
	_accelCorrection.z = z;
}

void AccelGyro::SetGyroCorrection(double x, double y, double z) {
	_gyroCorrection.x = x;
	_gyroCorrection.y = y;
	_gyroCorrection.z = z;
}

Correction AccelGyro::GetAccelCorrection() {
	return _accelCorrection;
}

Correction AccelGyro::GetGyroCorrection() {
	return _gyroCorrection;
}

void AccelGyro::CalibrateGyro() {
	RawSensorData gyroRawData;
	unsigned long totalRawX, totalRawY, totalRawZ;
	totalRawX = 0;
	totalRawY = 0;
	totalRawZ = 0;
	SetGyroCorrection(0.0, 0.0, 0.0);
	for (int i = 0; i < CALIBRATION_SAMPLES; i++) {
		gyroRawData = GetRawData(GYRO_DATA_REG);
		totalRawX += gyroRawData.x;
		totalRawY += gyroRawData.y;
		totalRawZ += gyroRawData.z;
		delay(3);
	}
	SetGyroCorrection(totalRawX / CALIBRATION_SAMPLES, totalRawY / CALIBRATION_SAMPLES, totalRawZ / CALIBRATION_SAMPLES);
	_rotation = GetRotationAccel();
	_prevMeasurementTime = micros();
}

void AccelGyro::CalibrateAccel() {
	Rotation totalAccelRotation, accelRotation;
	SetAccelCorrection(0.0, 0.0, 0.0);
	totalAccelRotation = Rotation(0.0, 0.0, 0.0);
	for (int i = 0; i < CALIBRATION_SAMPLES; i++) {
		accelRotation = GetRotationAccel();
		totalAccelRotation.Add(accelRotation);
		delay(3);
	}
	SetAccelCorrection(totalAccelRotation.x / CALIBRATION_SAMPLES, totalAccelRotation.y / CALIBRATION_SAMPLES, totalAccelRotation.z / CALIBRATION_SAMPLES);
}

void AccelGyro::Calibrate() {
	CalibrateAccel();
	CalibrateGyro();
}